@{
    ViewData["Title"] = "Bảng điều khiển quản trị";
    var topProducts = ViewBag.TopProducts as IEnumerable<dynamic>;
}

<div class="container py-5">
    <h2 class="fw-bold mb-4 text-center text-uppercase">
        <i class="bi bi-speedometer2 text-primary"></i> Bảng điều khiển quản trị
    </h2>

    <!-- 🧮 Thống kê tổng quan -->
    <div class="row text-center mb-5">
        <div class="col-md-3">
            <div class="card shadow-sm border-primary">
                <div class="card-body">
                    <i class="bi bi-box-seam fs-2 text-primary"></i>
                    <h4 class="fw-bold mt-2">@ViewBag.TotalProducts</h4>
                    <p class="text-muted mb-0">Sản phẩm</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-success">
                <div class="card-body">
                    <i class="bi bi-people fs-2 text-success"></i>
                    <h4 class="fw-bold mt-2">@ViewBag.TotalUsers</h4>
                    <p class="text-muted mb-0">Người dùng</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-warning">
                <div class="card-body">
                    <i class="bi bi-bag-check fs-2 text-warning"></i>
                    <h4 class="fw-bold mt-2">@ViewBag.TotalOrders</h4>
                    <p class="text-muted mb-0">Đơn hàng</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-danger">
                <div class="card-body">
                    <i class="bi bi-cash-stack fs-2 text-danger"></i>
                    <h4 class="fw-bold mt-2">@($"{ViewBag.TotalRevenue:N0}") đ</h4>
                    <p class="text-muted mb-0">Doanh thu</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 📈 Biểu đồ -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white fw-bold">
                    <i class="bi bi-bar-chart"></i> Doanh thu theo tháng
                </div>
                <div class="card-body">
                    <canvas id="revenueChart" height="200"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white fw-bold">
                    <i class="bi bi-graph-up"></i> Đơn hàng theo tháng
                </div>
                <div class="card-body">
                    <canvas id="orderChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- 🏆 Top 5 sản phẩm bán chạy -->
    <div class="card shadow-sm mt-4">
        <div class="card-header bg-warning fw-bold text-dark">
            <i class="bi bi-star-fill"></i> Top 5 sản phẩm bán chạy
        </div>
        <div class="card-body">
            @if (topProducts != null && topProducts.Any())
            {
                <div class="table-responsive">
                    <table class="table align-middle table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Ảnh</th>
                                <th>Tên sản phẩm</th>
                                <th>Số lượng bán</th>
                                <th>Doanh thu</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var p in topProducts)
                            {
                                <tr>
                                    <td style="width:80px;">
                                        <img src="@(string.IsNullOrWhiteSpace(p.ImageUrl) ? "/images/no-image.png" : p.ImageUrl)"
                                             class="img-thumbnail rounded" style="width:60px;height:60px;object-fit:cover;" />
                                    </td>
                                    <td>@p.Name</td>
                                    <td><span class="fw-bold text-success">@p.TotalQuantity</span></td>
                                    <td><span class="fw-bold text-danger">@($"{p.TotalRevenue:N0}") đ</span></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <p class="text-muted">Chưa có dữ liệu sản phẩm bán chạy.</p>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const revenueData = @Html.Raw(ViewBag.RevenueData ?? "[]");
        const orderData = @Html.Raw(ViewBag.OrderData ?? "[]");
        const months = ['T1','T2','T3','T4','T5','T6','T7','T8','T9','T10','T11','T12'];

        const revenueValues = months.map((_, i) => {
            const item = revenueData.find(x => x.Month === i + 1);
            return item ? item.Revenue : 0;
        });
        const orderValues = months.map((_, i) => {
            const item = orderData.find(x => x.Month === i + 1);
            return item ? item.Count : 0;
        });

        // Biểu đồ doanh thu
        new Chart(document.getElementById('revenueChart'), {
            type: 'bar',
            data: {
                labels: months,
                datasets: [{
                    label: 'Doanh thu (VNĐ)',
                    data: revenueValues,
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1,
                    borderRadius: 5
                }]
            },
            options: {
                scales: { y: { beginAtZero: true, ticks: { callback: v => v.toLocaleString() + ' đ' } } },
                plugins: { legend: { display: false } }
            }
        });

        // Biểu đồ đơn hàng
        new Chart(document.getElementById('orderChart'), {
            type: 'line',
            data: {
                labels: months,
                datasets: [{
                    label: 'Số đơn hàng',
                    data: orderValues,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.3,
                    borderWidth: 3,
                    fill: true,
                    pointRadius: 5
                }]
            },
            options: {
                scales: { y: { beginAtZero: true } },
                plugins: { legend: { display: false } }
            }
        });
    </script>
}
